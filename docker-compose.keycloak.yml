version: "3.8"

services:
    postgres-keycloak:
        image: postgres:16-alpine
        container_name: mytradingwiki-postgres-keycloak
        environment:
            POSTGRES_DB: keycloak
            POSTGRES_USER: keycloak
            POSTGRES_PASSWORD: keycloak
        volumes:
            - postgres_keycloak_data:/var/lib/postgresql/data
        networks:
            - keycloak-net
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U keycloak"]
            interval: 10s
            timeout: 5s
            retries: 5

    keycloak:
        image: quay.io/keycloak/keycloak:25.0.2
        container_name: mytradingwiki-keycloak
        environment:
            # Database
            KC_DB: postgres
            KC_DB_URL_HOST: postgres-keycloak
            KC_DB_URL_DATABASE: keycloak
            KC_DB_USERNAME: keycloak
            KC_DB_PASSWORD: keycloak

            # Admin user
            KEYCLOAK_ADMIN: admin
            KEYCLOAK_ADMIN_PASSWORD: admin

            # Development mode settings
            KC_HOSTNAME: localhost
            KC_HOSTNAME_PORT: 8080
            KC_HTTP_ENABLED: "true"
            KC_LOG_LEVEL: info
        ports:
            - "8080:8080"
        volumes:
            # Mount custom theme JAR
            - ./dist_keycloak/keycloak-theme-for-kc-22-to-25.jar:/opt/keycloak/providers/mytradingwiki-theme.jar:ro
        command:
            - start-dev
        depends_on:
            postgres-keycloak:
                condition: service_healthy
        networks:
            - keycloak-net
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /health/ready HTTP/1.1\r\nhost: http://localhost\r\nConnection: close\r\n\r\n' >&3;if [ $? -eq 0 ]; then echo 'Healthcheck Successful';exit 0;else echo 'Healthcheck Failed';exit 1;fi;"
                ]
            interval: 15s
            timeout: 10s
            retries: 10
            start_period: 60s

    keycloak-init:
        image: quay.io/keycloak/keycloak:25.0.2
        container_name: mytradingwiki-keycloak-init
        environment:
            KEYCLOAK_ADMIN: admin
            KEYCLOAK_ADMIN_PASSWORD: admin
        volumes:
            - ./docker/keycloak-init.sh:/tmp/keycloak-init.sh:ro
        entrypoint: ["/bin/bash", "/tmp/keycloak-init.sh"]
        depends_on:
            keycloak:
                condition: service_healthy
        networks:
            - keycloak-net
        restart: "no"

networks:
    keycloak-net:
        driver: bridge

volumes:
    postgres_keycloak_data:
        driver: local
